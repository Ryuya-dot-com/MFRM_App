<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MFRM Analysis Dashboard</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
</head>
<body>
  <div id="app">
    <header class="app-header">
      <div>
        <h1>Many-Facet Rasch Model (MFRM) Analysis</h1>
        <p class="subtitle">Run a brms cumulative link mixed model through an API + SPA workflow</p>
      </div>
      <div class="api-config">
        <label for="apiBase">API Endpoint</label>
        <input id="apiBase" type="text" placeholder="https://your-backend.example.com" />
        <button id="saveApiBase" class="secondary">Save</button>
      </div>
    </header>

    <div class="app-body">
      <aside class="sidebar" id="sidebar">
        <section>
          <h2>Step 1: Data Entry</h2>
          <p class="hint">Review the template, then paste or upload your data file.</p>
          <div class="radio-row">
            <label><input type="radio" name="dataMode" value="paste" checked /> Paste</label>
            <label><input type="radio" name="dataMode" value="upload" /> File Upload</label>
          </div>
          <div id="pasteContainer">
            <textarea id="pastedData" rows="12">Person	Task	Rater	Criterion	Rating
P01	Task1	Rater1	Content	4
P01	Task1	Rater2	Grammar	3
P01	Task2	Rater3	Vocabulary	5
P02	Task1	Rater1	Content	2
P02	Task2	Rater2	Grammar	3
P02	Task3	Rater3	Delivery	1
P03	Task1	Rater1	Content	5
P03	Task2	Rater2	Delivery	4
P03	Task3	Rater3	Vocabulary	2
P04	Task1	Rater1	Content	3
P04	Task2	Rater2	Grammar	4
P05	Task1	Rater3	Delivery	5
P05	Task2	Rater3	Vocabulary	
P06	Task3	Rater2		3</textarea>
            <div class="single-row">
              <textarea id="singleRow" rows="2" placeholder="Add one row (e.g. P06\tTask1\tRater2\tContent\t4)"></textarea>
              <div class="btn-group-vertical">
                <button id="appendRow" class="secondary">Append Row</button>
                <button id="clearRows" class="link">Reset Template</button>
              </div>
            </div>
          </div>
          <div id="uploadContainer" class="hidden">
            <input type="file" id="fileInput" accept=".csv,.tsv,text/csv,text/tab-separated-values" />
          </div>
          <div class="button-row">
            <button id="downloadTSV" class="secondary">Download Sample TSV</button>
            <button id="downloadCSV" class="secondary">Download Sample CSV</button>
          </div>
        </section>

        <section>
          <h2>Step 2: Data Settings</h2>
          <div class="form-control">
            <label><input type="checkbox" id="hasHeader" checked /> Header row present</label>
          </div>
          <div class="form-control">
            <label for="separator">Delimiter</label>
            <select id="separator">
              <option value="\t">Tab</option>
              <option value=",">Comma</option>
              <option value=";">Semicolon</option>
            </select>
          </div>
          <button id="loadData" class="primary">Load Data</button>
        </section>

        <section>
          <h2>Step 3: Column Mapping</h2>
          <div class="form-control">
            <label for="personCol">Person ID</label>
            <select id="personCol"></select>
          </div>
          <div class="form-control">
            <label for="responseCol">Rating Column</label>
            <select id="responseCol"></select>
          </div>
          <div class="form-control">
            <p class="label">Facet Columns</p>
            <p class="hint small">The person column is included automatically. Check only the facets you want to estimate (e.g. raters, tasks).</p>
            <div id="facetCols" class="checkbox-grid"></div>
          </div>
        </section>

        <section>
          <h2>Step 4: Model Settings</h2>
          <div class="form-control">
            <label for="linkFunction">Link Function</label>
            <select id="linkFunction">
              <option value="logit">Logit</option>
              <option value="probit">Probit</option>
              <option value="cauchit">Cauchit</option>
              <option value="loglog">Log-log</option>
            </select>
          </div>
          <div class="form-control">
            <label for="threshold">Threshold Structure</label>
            <select id="threshold">
              <option value="flexible">Flexible</option>
              <option value="symmetric">Symmetric</option>
              <option value="equidistant">Equidistant</option>
            </select>
          </div>
        </section>

        <section>
          <h2>Step 5: Analysis</h2>
          <button id="runAnalysis" class="success">Run MFRM Analysis</button>
          <p id="statusMessage" class="status" role="status" aria-live="polite"></p>
        </section>
      </aside>

      <main class="content">
        <div class="tab-bar" id="tabBar" role="tablist">
          <button id="tabbtn-preview" data-tab="preview" class="active" role="tab" aria-selected="true" aria-controls="tab-preview">Data Preview</button>
          <button id="tabbtn-summary" data-tab="summary" role="tab" aria-selected="false" aria-controls="tab-summary">Model Summary</button>
          <button id="tabbtn-facets" data-tab="facets" role="tab" aria-selected="false" aria-controls="tab-facets">Facet Estimates</button>
          <button id="tabbtn-reliability" data-tab="reliability" role="tab" aria-selected="false" aria-controls="tab-reliability">Reliability & Separation</button>
          <button id="tabbtn-fit" data-tab="fit" role="tab" aria-selected="false" aria-controls="tab-fit">Fit Diagnostics</button>
          <button id="tabbtn-dimensionality" data-tab="dimensionality" role="tab" aria-selected="false" aria-controls="tab-dimensionality">Dimensionality</button>
          <button id="tabbtn-wright" data-tab="wright" role="tab" aria-selected="false" aria-controls="tab-wright">Wright Map</button>
          <button id="tabbtn-thresholds" data-tab="thresholds" role="tab" aria-selected="false" aria-controls="tab-thresholds">Thresholds</button>
          <button id="tabbtn-residuals" data-tab="residuals" role="tab" aria-selected="false" aria-controls="tab-residuals">Residuals</button>
          <button id="tabbtn-descriptives" data-tab="descriptives" role="tab" aria-selected="false" aria-controls="tab-descriptives">Descriptives</button>
          <button id="tabbtn-help" data-tab="help" role="tab" aria-selected="false" aria-controls="tab-help">Help</button>
          <button id="tabbtn-downloads" data-tab="downloads" role="tab" aria-selected="false" aria-controls="tab-downloads">Downloads</button>
        </div>

        <section id="tab-preview" class="tab-panel active" role="tabpanel" aria-labelledby="tabbtn-preview">
          <h2>Data Preview</h2>
          <div id="dataPreviewTable" class="table-container"></div>
          <h3>Column Overview</h3>
          <div id="dataStructureTable" class="table-container"></div>
          <h3>Rating Distribution</h3>
          <div id="responsePlot" class="plot"></div>
        </section>

        <section id="tab-summary" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-summary" aria-hidden="true">
          <h2>Model Summary</h2>
          <div class="callouts">
            <div id="metadataMessages" class="callout info hidden"></div>
            <div id="metadataWarnings" class="callout warning hidden"></div>
          </div>
          <div class="grid-two">
            <div>
              <h3>Configuration</h3>
              <div id="modelSummaryTable" class="table-container"></div>
            </div>
            <div>
              <h3>MCMC Diagnostics</h3>
              <div id="convergenceTable" class="table-container"></div>
            </div>
          </div>
          <h3>Variance Components</h3>
          <div id="randomEffectsTable" class="table-container"></div>
          <h3>Model Fit Indices</h3>
          <div id="modelFitTable" class="table-container"></div>
        </section>

        <section id="tab-facets" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-facets" aria-hidden="true">
          <h2>Facet Estimates</h2>
          <div id="facetTables"></div>
        </section>

        <section id="tab-reliability" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-reliability" aria-hidden="true">
          <h2>Reliability & Separation Indices</h2>
          <div id="reliabilityTable" class="table-container"></div>
          <h3>Interpretation Guide</h3>
          <div id="interpretationGuide" class="table-container"></div>
          <h3>Effect Overview</h3>
          <div id="reliabilityPlot" class="plot"></div>
        </section>

        <section id="tab-fit" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-fit" aria-hidden="true">
          <h2>Fit Diagnostics</h2>
          <div id="fitStatisticsTable" class="table-container"></div>
          <div class="grid-two">
            <div>
              <h3>Mean-square</h3>
              <div id="msqPlot" class="plot"></div>
            </div>
            <div>
              <h3>ZSTD Scatter</h3>
              <div id="zstdPlot" class="plot"></div>
            </div>
          </div>
        </section>

        <section id="tab-dimensionality" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-dimensionality" aria-hidden="true">
          <h2>Dimensionality (Residual PCA)</h2>
          <div class="facet-selector">
            <label for="pcaFacetSelect">Facet</label>
            <select id="pcaFacetSelect"></select>
          </div>
          <h3>Eigenvalues</h3>
          <div id="pcaEigenTable" class="table-container"></div>
          <h3>Loadings Plot</h3>
          <div id="pcaLoadingsPlot" class="plot"></div>
        </section>

        <section id="tab-thresholds" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-thresholds" aria-hidden="true">
          <h2>Thresholds & Category Probabilities</h2>
          <div id="thresholdTable" class="table-container"></div>
          <h3>Threshold Locations</h3>
          <div id="thresholdMap" class="plot"></div>
          <h3>Category Probability Curves</h3>
          <div id="probabilityPlot" class="plot"></div>
        </section>

        <section id="tab-residuals" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-residuals" aria-hidden="true">
          <h2>Residual Diagnostics</h2>
          <div class="grid-two">
            <div>
              <h3>Residuals vs Fitted</h3>
              <div id="residualScatter" class="plot"></div>
            </div>
            <div>
              <h3>Standardised Residual Q-Q Plot</h3>
              <div id="qqPlot" class="plot"></div>
            </div>
          </div>
          <div class="grid-two">
            <div>
              <h3>Residual Distribution</h3>
              <div id="residualDensity" class="plot"></div>
            </div>
            <div>
              <h3>Observed vs Predicted</h3>
              <div id="observedFitted" class="plot"></div>
            </div>
          </div>
        </section>

        <section id="tab-wright" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-wright" aria-hidden="true">
          <h2>Wright Map</h2>
          <div id="wrightMap" class="plot"></div>
          <h3>Facet Comparison</h3>
          <div id="facetComparison" class="plot"></div>
        </section>

        <section id="tab-descriptives" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-descriptives" aria-hidden="true">
          <h2>Descriptive Statistics</h2>
          <div id="overallStats" class="table-container"></div>
          <h3>By Facet</h3>
          <div id="facetStats"></div>
        </section>

        <section id="tab-help" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-help" aria-hidden="true">
          <h2>Help & Guidance</h2>
          <p>This dashboard runs a Many-Facet Rasch Model (MFRM) via a cumulative link mixed model backend. Follow the steps in the left panel to prepare your data and configure the model.</p>
          <h3>Quick Start</h3>
          <ol>
            <li>Paste data into the template or upload a CSV/TSV file.</li>
            <li>Check the parsing options (header, delimiter) and load the preview.</li>
            <li>Map the person, rating, and facet columns.</li>
            <li>Select the link function and threshold structure, then run the analysis.</li>
            <li>Review the tabs in order and download CSV summaries as needed.</li>
          </ol>
          <h3>Minimum Data Requirements</h3>
          <ul>
            <li>Long-format data with one row per rating (Person × Task × Rater × Criterion).</li>
            <li>An ordered response column with at least two categories (three or more recommended).</li>
            <li>A person identifier plus at least one additional facet for random-effect estimation.</li>
            <li>For stable estimates aim for ≥30 observations and ≥3 levels per facet.</li>
          </ul>
          <h3>Key Indices</h3>
          <ul>
            <li><strong>Reliability</strong>: Proportion of true variance (target &gt; 0.80).</li>
            <li><strong>Separation</strong>: Spread in standard error units (target &gt; 2.0).</li>
            <li><strong>Strata</strong>: Distinct measurement strata ((4 × Separation + 1)/3).</li>
            <li><strong>RMSE</strong>: Measurement precision; lower values indicate better fit.</li>
            <li><strong>Adjusted SD</strong>: True spread after removing measurement error.</li>
          </ul>
          <h3>Model Notes</h3>
          <ul>
            <li>Uses cumulative link functions (logit, probit, cauchit, log-log).</li>
            <li>Includes random effects for persons and selected facets.</li>
            <li>Supports flexible, symmetric, or equidistant threshold structures.</li>
          </ul>
          <p class="hint">See the project README for a full walkthrough and interpretation tips.</p>
        </section>

        <section id="tab-downloads" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-downloads" aria-hidden="true">
          <h2>CSV Downloads</h2>
          <p>Once the analysis completes you can export the following tables.</p>
          <div class="button-row" id="downloadButtons">
            <button data-resource="summary" class="secondary" disabled>Summary</button>
            <button data-resource="reliability" class="secondary" disabled>Reliability</button>
            <button data-resource="fit" class="secondary" disabled>Fit Statistics</button>
            <button data-resource="thresholds" class="secondary" disabled>Thresholds</button>
            <button data-resource="facets" class="secondary" disabled>Facet Parameters</button>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="assets/config.js"></script>
  <script src="assets/app.js"></script>
</body>
</html>
